Kaldi是围绕隐马尔科夫模型的，“端到端”可以不需要隐马尔科夫模型，混合神经网络，双向长短记忆神经网络+CTC目标函数

Y是输入音频，w是真正的词序列，求最大的P(w|Y)。由贝叶斯可得P(w|Y) = P(Y|w)P(w)/P(Y)。其中Y为确定值，于是P(Y)为常数，求极值时可以忽略。     
对P(Y|w)和P(w)分开建模：     
P(Y|w)在给定单词序列w时，可以得到特定音频信号Y的的概率，通常称为声学模型。    
P(w)给定单词序列w的概率。通常称为语言模型。     
Y通常每隔10毫秒在25毫秒的时间窗口中提取一个特征向量，输入概率模型的Y实际中通常是一系列特征向量的序列    
单词序列w通常会拆成一个音素序列     
Q是单词序列w对应的发音单元序列，这里简化为音素序列，那么声学模型p(Y|w)=∑p(Y|Q)P(Q|W)，这个求和是单词序列w对应的所有可能得音素序列Q的集合计算边缘分布概率。于是声学模型就拆分成P(Y|Q)和P(Q|w)。特征向量|音素、音素|词序列     
（第九页）P(Q|w)：w中每个词发音为q的概率乘积。单词可能有多个发音，但通常多音词的发音不会很多，因此P(Q|w)比较容易从发音词典中计算出来。注：多音词不是带有多音字的词，多音词不同发音意义不同     
P(Y|Q)是声学模型的核心，Q中每一个音素构建一个隐马尔科夫模型单元，根据Q的音素序列拼成一个句子级别的的隐马尔科夫模型，特征序列Y是隐马尔可夫模型的可观察输出。实际中要复杂一些，比如使用上下文三音子作为隐马尔科夫单元     
P(w)，用前n-1个词预测第n个词，n一般取3、4，已知w0...w(l-1)，下一次是wl的概率     

### 语音信号处理：     
音频采样：采样记录电流值，两次采样的间隔称为采样周期，它的倒数是采样频率。例如每隔1/16000秒采样一次，采样频率为16000Hz。    
量化：11页，样点格式转化     
回声消除    
噪声抑制：频域抑制、空域抑制     
动态增益控制     
音频编解码：主要用于网络传输     
其中，采样和量化是声音信号转换为计算机数据必不可少的方法     

发音和语言学：人类语音答题可分为有限的若干基本元素，称为音素    
发音词典：表意单元与音素组合之间的映射。音素是人为定义概念，所以不同语言有不同的音素集，不同的发音词典。汉语常用拼音，由于多音字和多音词，发音词典并不一一映射。除语音音素，通常还要加入非语音音素如静音音素、噪音音素等。          
实际中，还要考虑上下文影响造成的协同发音。喝多技术都是为了处理协同发音，例如：每个音素往往分为多个状态，分别对应不同的发音阶段，不同阶段的差异主要是受上下文的相邻音素影响。再比如，对每个音素建模时，建模对象实际上是由上下文音素组成的三音子(Triphone)组合。     

语音识别评价：错误率(插入、删除、替换)、正确率、实时率(耗时÷句子时长)。错误率可能大于100%。     


### Kaldi集群    
小型集群：
需要子任务进程对同一目录有读写权限，需要搭建网络文件系统(NFS),需要确保同一用户在不同机器上使用相同的UID和GID：id -u xxx和id -g xxx     
完成NFS后，在要加入集群的机器上设置互相之间的免密登录，确认NFS的挂载点在所有机器上有相同的访问权限     
大型集群：
Kaldi支持：SGE(Sun Grid Engine) 和 SLURM(Simple Linux Utility for Resource Management)，默认用SGE，但书上推荐自己维护的读者使用SLURM。  

多数示例默认用sge集群 queue.pl   

单机 run.pl    

配置了 NFS 和免密登录，可以使用 ssh.pl 进行任务分发，需要在训练环境目录创建 .queue 文件夹没在其中创建 machines 文件，将要使用的机器名写在里面：   
$ cat  .queue/machines   
a01   
a02   
a03   

SLURM集群 slurm.pl   

### 脚本解析：     
utils/run.pl 这个Perl脚本的作用是用多任务执行某个程序，可以独立于Kaldi之外使用。在steps的train_mono.sh、decode.sh等很多脚本都可以通过cmd参数使用它。   
utils/run.pl JOB=1:n(数字) /...(路径)/log.JOB.txt echo "This is a job JOB"     该命令同时执行n个echo命令，并发屏幕显示分别写入log.[1-n].txt这n个文本中     
Kaldi提供了 run.pl、queue.pl 和 slurm.pl。     
数据整理主要有两个目的，一是整理成Kaldi规范的数据文件夹格式；二是划分测试集和训练集。     
每个句子被指定了一个唯一ID   
wav.scp 记录每个ID的音频文件路径   
text 记录每个ID的文本内容
spk2utt 和 utt2spk 记录每个ID的说话人信息   
还需要手工准备：   
发音词典 lexicon.txt   
lexicon_nosil.txt 和 lexicon类似，只是去掉了<SIL>   
phones.txt 音素集，也可硬从lexicon.txt 文件中的所有音素去重得到   

task.arpabo 语言模型   

prepare_lang.sh 生成语言文件夹 data/lang 存储了待识别的单词集、音素集等信息
local/prepare_lm.sh 把语言模型构建成图   

接下来是定义声学特征，它是训练声学模型的基础：执行完生成 feats.scp 记录了声学特征的存储位置   
steps/make_mfcc.sh compute_cmvn_stats.sh utils/fix_data_dir.sh

之后是声学模型训练和测试,steps/train_mono.sh   

识别也叫解码steps/decode.sh，解码前需要构建状态图utils/mkgraph.sh   

解码会使用不同的解码参数生成多个文件，WER有微小的差异，最后找到最好的结果   

local 包含用于处理当前示例数据的脚本、识别测试的脚本及除 GMM 训练外其他训练步骤的脚本   

steps 和 utils 是两个指向wsj下同名文件夹的链接   
steps 是各个训练阶段的子脚本。如：特征提取、单音素的 GMM 训练、三音素的 GMM 训练、神经网络模型训练、解码等   
utils 用于协助处理。如：任务管理、文件夹整理、临时文件删除、数据复制和验证等   
另外，还有一些特殊的顶层文件或文件夹。如：说话人识别、语种识别、图像识别、神经网络等 P43   

### 数据准备
训练 开发 测试 的用途和分布
不同质量,如清晰程度的数据用于不同阶段和场景
多机训练要确保数据路径在每个节点上都是可直接读写的

排序很重要，按字符串而非数值顺序，例112会排在12前面

p73
例如：创建 utt2spk 时需要注意排序。3.3中讲到 Kaldi 接收多个输入表单，第一个输入表单是按顺序读入的，但对其处理过程中用到的其他表单是按第一个表单元素的索引随机读取的，为了解决管道输入问题，可以约定将所有输入表单按索引裴谞，如3.3的 paste-feats 示例。   
有时多个表单单位可能不同，如特征归一化过程中按顺序读取的输入表单是以句子为单位的声学特征，但是随机读取的输入表单是以说话人为单位的归一化系数。在归一化程序处理一个句子的特征数据时，会根据 utt2spk 提供的映射结果，去读取对应说话人的归一化系数。此时，如果 utt2spk 中说话人的排序和 cmvn.scp 中说话人索引的排序方式不同，就会导致可执行程序需要将全部说话人的归一化系数加载到内存中。如果能确保 utt2spk 同时满足句子索引和说话人索引的排序，就可以使用 s 和 cs 声明符提高运算效率。常用方法是将说话人索引作为句子索引的前缀，就可以保证在以句子索引排序 utt2spk 时，说话人索引也是正确的。
有一个特殊情况，说话人长度不确定，可以使用ASCII值比较小的符号，如 “—” 作为说话人索引前缀连接符(LC_ALL=C)。

音频时长表单 get_utt2dur.sh

列表表单用于索引文件，通常以scp做扩展名，可以是物理地址，也可以是管道形式表示的内存地址，指向二进制Kaldi存档文件时还可以增加偏移定位指示从某一字节开始的内容，如aaa.ark:11只从aaa.ark的第11字节开始获取，如果指向的是矩阵文件，还可以进一步扩展，指定所需的行列范围,Kaldi的声学特征是用矩阵表示的，一行对一帧，列对应特征维度，如果需要获取声学特征的前10维，如果aaa.ark保存的是声学特征则可用aaa.ark:11[:,0:9]，[:,0:9]表示行列范围，所有行的0~9维，取所有时"："可以省略简写为[,0:9]，行列以“，”分隔     
存档表单用于存储数据，可以是文本或二进制，通常以ark做扩展名，但没有严格限制。存档表单没有行的概念，元素之间没有间隔符，对于文本类型的存档表单，必须保证每个元素以换行符结尾。与列表文件区别：p60     

rspecifier 读声明符，指定一个输入表单   
wspecifier 写声明符，指定一个输出表单   

### 表单属性：   
写属性:   
表单类型:scp、ark，如果同时输出scp和ark，必须ark在前，逗号分隔：ark,scp:.../aaa.ark,.../aaa.scp   
二进制模式标识符b，表示输出表单保存为二进制文件，只对输出存档表单有效，不指定默认就是二进制   
文本模式为t，同样只对存档表单有效，因为列表只能是文本   
刷新模式,f是表示刷新,nf表示不刷新，用于确定每次写操作之后是否刷新数据流，默认刷新。有利于优化内存使用，通常不用更改   
宽容模式p，只对输出列表表单有效。例如，同时输出存档表单和列表表单时，如果表单某个元素对应的存档表单无法获取，那么列表表单中会直接跳过这个元素，不提示错误。   
读属性:   
输入时，不能用逗号分隔同时输入多个表单文件，可通过多个读声明符实现。   
单次访问符号为o，它告知可执行程序，在读入表单中，每个索引只出现一次，不会有多个元素使用同一索引的情况。多次访问为no。   
宽容模式，符号p或np，输入的列表表单中某文件不存在或存档表单中元素内容有误，不报错，只打警告。   
有序表单，s为有序，ns无序，告知可执行程序，输入表单的元素索引是有序的，按字符串顺序。   
有序访问，cs或ncs，告知可执行程序，元素将被顺序访问。   
存储格式，新设计不再使用，P66。   

由于按字符串顺序，也就是字节的ASCII值排序，所以在Linux中会受到语言环境设置影响。locale命令可查看，其中 LC_COLLATE 决定了排序时的规则。Kaldi的可执行程序是C++写的，LC_COLLATE=C的排序结果与内存表单元素排序结果一致。因此，Kaldi通用脚本中凡涉及调用排序指令时，都会出现 export LC_ALL=C，这个设置只在脚本执行周期内生效。如果需要单独使用可执行程序排序，或在自己编写的脚本中排序，必须添加系统语言设置语句。   

utils中有一个data文件夹，其中脚本多是用于处理数据文件夹的。   

### 列表类数据表单：   
句子音频表单：wav.scp，可以是切分为每句的或未切分的多句的，如果是未切分的，需要配合切分表(Segments)单使用   
声学特征表单：feats.scp，每个元素表示一个句子   
谱特征归一化表单：cmvn.scp，通用声学特征处理脚本提取的谱归一化系数文件，可以以句子和说话人为单位   
VAD信息表单：vad.scp，表单元素由compute-vad提取，由提取VAD的通用脚本生成，以句子为单位。（语音活动检测(Voice Activity Detection)又称语音端点检测,语音边界检测）   

### 列表类数据表单：  
说话人映射表单：utt2spk、spk2utt   
标准文本表单：text，每一句的标注，应当是文本归一化后的内容。归一化指，文本中的词都在发音字典和语言模型的词表中，未出现的词都被当做未知词，英文要统一大小写，中文要做好分词。   
切分信息表单：segments。Kaldi的数据处理以句子为单位，如果音频没按句子切分，就需要将每一句起止时间记录在 segments 中。文本类型，以句子为索引，索引与音频表单一致，以秒为单位。p75  


VTLN Vocal Tract Length Normalisation 声道长度归一化






|脚本     |   功能|
|:-:|:-:|
|combine_data.sh                  | 将多个数据文件夹合并为一个，并合并对应的表单 |
|combine_short_segments.sh        | 合并原文件夹中的短句，创建一个新的数据 文件夹 |
|copy_data_dir.sh                 | 复制原文件夹，创建一个新的数据文件夹，可以指定说话人或句子的前缀、后缀，复制部分数据|
|extract_wav_segments_data_dir.sh | 利用原文件夹中的分段信息，切分音频文件，并保存为一一 个新的数据文件夹|
|fix_data_dir.sh                  | 为原文件夹保留一个备份，删除没有同时出现在多个表单中的句子，并修正排序|
|get_frame_shift.sh               | 获取数据文件夹的帧移信息，打印到屏幕|
|get_num_frames.sh                | 获取数据文件夹的总帧数信息，打印到屏幕|
|get_segments_for_data.sh         | 获取音频时长信息，转换为segments文件|

